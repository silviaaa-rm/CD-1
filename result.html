<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Resultado | Hospital</title>
  <link rel="stylesheet" href="styles.css" />
</head>

<body class="clinic">
  <div class="clinic-wrap">

    <!-- Header con logo + acciones -->
    <header class="clinic-top">
      <div class="clinic-brand">
        <img class="clinic-logo" src="https://www.laconcepcion.com.mx/assets/images/logo-color132.png" alt="Logotipo del hospital" />
        <div class="clinic-brand-text">
          <div id="welcome" class="clinic-welcome">Resultado y recomendación</div>
          <div id="who" class="clinic-who"></div>
        </div>
      </div>

      <div class="clinic-actions">
        <button id="back" class="btn-light">Volver</button>
        <button id="logout" class="btn-light">Cerrar sesión</button>
      </div>
    </header>

    <!-- Contenido -->
    <main class="clinic-grid">

      <!-- Panel izquierdo: Detección -->
      <section class="card clinic-card">
        <div class="card-head">
          <div>
            <h3 class="card-title">Detección</h3>
            <p class="card-subtitle">Información orientativa — no sustituye diagnóstico médico.</p>
          </div>
          <div class="badge">Resultado</div>
        </div>

        <div class="result-box">
          <div class="result-line">
            <span class="result-label">Padecimiento detectado</span>
            <span id="label" class="result-value">—</span>
          </div>
          <div class="result-line">
            <span class="result-label">Confianza</span>
            <span id="conf" class="result-value">—</span>
          </div>
        </div>

        <p class="muted small" id="termInfo" style="margin-top:12px;"></p>
      </section>

      <!-- Panel derecho: Recomendaciones -->
      <aside class="card clinic-card">
        <div class="card-head">
          <div>
            <h3 class="card-title">Recomendación</h3>
          </div>
        </div>

        <h4 class="sec-title">Recomendación rápida</h4>
        <div id="quickRec" class="sec-body">Cargando…</div>

        <h4 class="sec-title" style="margin-top:14px;">Signos de alarma</h4>
        <div id="redFlags" class="sec-body">Cargando…</div>
      </aside>

    </main>

    <!-- Fuentes -->
    <section class="card clinic-card" style="margin-top:16px;">
      <div class="card-head">
        <div>
          <h3 class="card-title">Fuentes</h3>
          <p class="card-subtitle">Sitios médicos/reconocidos usados como referencia.</p>
        </div>
      </div>

      <div id="sources" class="sec-body">Cargando…</div>
    </section>

  </div>

  <script>
    // ====== Seguridad ======
    const raw = localStorage.getItem("doctor_session");
    if (!raw) window.location.href = "index.html";
    const session = JSON.parse(raw);

    // Header
    document.getElementById("welcome").textContent = `¡Bienvenido(a), ${session.name}!`;
    document.getElementById("who").textContent = `Usuario: ${session.username}`;

    // Navegación
    document.getElementById("back").addEventListener("click", () => {
      window.location.href = "doctor.html";
    });
    document.getElementById("logout").addEventListener("click", () => {
      localStorage.removeItem("doctor_session");
      window.location.href = "index.html";
    });

    // ====== Predicción ======
    const predRaw = localStorage.getItem("last_prediction");
    if (!predRaw) window.location.href = "doctor.html";
    const pred = JSON.parse(predRaw);

    document.getElementById("label").textContent = pred.label;
    document.getElementById("conf").textContent = (pred.confidence * 100).toFixed(1) + "%";

    // Normaliza label (evita fallas por mayúsculas/espacios)
    const normalize = (s) => String(s || "").trim().toLowerCase();
    const predKey = normalize(pred.label);

    // ====== Recomendaciones locales (sin API) ======
    const RECS = {
      "cardiomegalia": {
        termInfo: "La radiografía muestra signos compatibles con un posible agrandamiento del corazón, lo cual puede estar asociado a hipertensión arterial, miocardiopatías o enfermedades valvulares.",
        quick: [
          "Complementar con electrocardiograma y ecocardiograma para evaluar tamaño y función cardíaca.",
          "Considerar estudios adicionales según criterio médico (análisis de sangre y/o imagen avanzada).",
          "El tratamiento depende de la causa e incluye control de presión arterial, ritmo cardíaco o retención de líquidos.",
          "Acudir a valoración con cardiología para confirmar diagnóstico y plan terapéutico."
        ],
        redFlags: [
          "Dificultad para respirar o falta de aire en reposo.",
          "Ritmo cardíaco anormal o palpitaciones intensas.",
          "Retención de líquidos (hinchazón en piernas).",
          "Dolor en el pecho o molestias en la parte superior del cuerpo."
        ],
        sources: [
          { name: "Apollo Hospitals: Agrandamiento del corazón", url: "https://www.apollohospitals.com/es/diseases-and-conditions/enlarged-heart-diagnosis-and-treatment" },
          { name: "NHLBI: Heart Failure (referencia)", url: "https://www.nhlbi.nih.gov/health/heart-failure" }
        ]
      },

      "neumotórax": {
        termInfo: "La radiografía sugiere la posible presencia de neumotórax, condición en la que el pulmón puede colapsarse por acumulación de aire en el espacio pleural.",
        quick: [
          "Recomendar valoración médica inmediata para confirmar diagnóstico con estudios complementarios.",
          "Dependiendo de la gravedad: observación médica o colocación de drenaje torácico.",
          "En casos recurrentes, el especialista puede considerar procedimientos preventivos.",
          "Acudir a urgencias si presenta dolor torácico intenso o falta de aire."
        ],
        redFlags: [
          "Dolor torácico súbito e intenso.",
          "Dificultad respiratoria (disnea).",
          "Tos seca persistente.",
          "Síncope (desmayo) o mareo intenso.",
          "Tos con sangre (hemoptisis)."
        ],
        sources: [
          { name: "Clínica Universidad de Navarra: Neumotórax", url: "https://www.cun.es/enfermedades-tratamientos/enfermedades/neumotorax" }
        ]
      },

      "neumonia bacteriana": {
        termInfo: "La radiografía muestra hallazgos compatibles con neumonía bacteriana. Se requiere valoración médica para confirmar diagnóstico y determinar gravedad.",
        quick: [
          "Seguir indicación médica para antibiótico (la elección depende del caso y del paciente).",
          "En casos leves: manejo ambulatorio con seguimiento; si hay gravedad: considerar hospitalización y tratamiento IV.",
          "Reposo, hidratación y completar el tratamiento indicado para evitar recaídas o complicaciones.",
          "Acudir a atención médica si hay fiebre persistente, falta de aire o empeoramiento."
        ],
        redFlags: [
          "Tos con sangre.",
          "Dolor torácico y fiebre con escalofríos.",
          "Cansancio extremo, dolores musculares o cefalea intensa.",
          "Dificultad respiratoria.",
          "Datos de sepsis/shock (debilidad severa, confusión, presión baja)."
        ],
        sources: [
          { name: "Mayo Clinic: Neumonía (diagnóstico y tratamiento)", url: "https://www.mayoclinic.org/es/diseases-conditions/pneumonia/diagnosis-treatment/drc-20354210" },
          { name: "Clínica Universidad de Navarra: Neumonía", url: "https://www.cun.es/enfermedades-tratamientos/enfermedades/neumonia" }
        ]
      },

      "tuberculosis": {
        termInfo: "La radiografía presenta hallazgos compatibles con un posible proceso infeccioso sugestivo de tuberculosis. Se recomienda valoración médica para confirmar.",
        quick: [
          "Confirmar con pruebas complementarias: tuberculina, análisis y/o estudio microbiológico de esputo según criterio médico.",
          "Si se confirma TB activa: tratamiento con combinación de antibióticos por varios meses bajo supervisión médica.",
          "Completar el tratamiento incluso si mejora, para evitar recaídas o resistencia.",
          "Consulta prioritaria si hay tos persistente, fiebre, sudoración nocturna, pérdida de peso o falta de aire."
        ],
        redFlags: [
          "Tos con sangre o dificultad respiratoria importante.",
          "Fiebre persistente, debilidad severa o pérdida de peso marcada.",
          "Empeoramiento rápido o dolor torácico fuerte."
        ],
        sources: [
          { name: "Mayo Clinic: Tuberculosis (diagnóstico y tratamiento)", url: "https://www.mayoclinic.org/es/diseases-conditions/tuberculosis/diagnosis-treatment/drc-20351256" }
        ]
      },

      "normal": {
        termInfo: "La radiografía de tórax no muestra alteraciones evidentes en los pulmones ni en la silueta cardíaca.",
        quick: [
          "No se identifican signos radiográficos evidentes de infección, colapso pulmonar ni agrandamiento cardíaco.",
          "Si existen síntomas persistentes (tos, fiebre, dolor torácico o falta de aire), se recomienda valoración médica: algunas condiciones pueden no ser visibles en etapas tempranas."
        ],
        redFlags: [
          "Falta de aire marcada, dolor en el pecho, desmayo o confusión.",
          "Fiebre persistente o empeoramiento rápido de síntomas."
        ],
        sources: [
          { name: "MedlinePlus (ES): Temas de salud", url: "https://medlineplus.gov/spanish/healthtopics.html" }
        ]
      }
    };

    const cfg = RECS[predKey];

    const termInfoEl = document.getElementById("termInfo");
    const quickEl = document.getElementById("quickRec");
    const flagsEl = document.getElementById("redFlags");
    const sourcesEl = document.getElementById("sources");

    if (!cfg) {
      termInfoEl.textContent = "No hay recomendación configurada para este label. Revisa coincidencia exacta del nombre.";
      quickEl.innerHTML = `<p>No configurado para: <kbd>${escapeHtml(pred.label)}</kbd></p>`;
      flagsEl.innerHTML = renderList(["Si hay síntomas graves o empeoran: acudir a urgencias."]);
      sourcesEl.innerHTML = `<p class="muted small">Agrega este label al objeto RECS en result.html.</p>`;
    } else {
      termInfoEl.textContent = cfg.termInfo || "";
      quickEl.innerHTML = renderList(cfg.quick || []);
      flagsEl.innerHTML = renderList(cfg.redFlags || []);
      sourcesEl.innerHTML = renderSources(cfg.sources || []);
    }

    function renderList(items){
      if (!items || !items.length) return `<p class="muted small">—</p>`;
      return `<ul class="nice-list">` + items.map(x => `<li>${escapeHtml(x)}</li>`).join("") + `</ul>`;
    }

    function renderSources(items){
      if (!items || !items.length) return `<p class="muted small">—</p>`;
      return `<ul class="nice-list">` + items.map(s =>
        `<li><a class="source-link" href="${s.url}" target="_blank" rel="noopener">${escapeHtml(s.name)}</a></li>`
      ).join("") + `</ul>`;
    }

    function escapeHtml(str) {
      return String(str).replace(/[&<>"']/g, m => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[m]));
    }
  </script>
</body>
</html>

